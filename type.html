<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puti-AI 中英打字遊戲</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            touch-action: manipulation;
        }
        .game-canvas {
            background: linear-gradient(to bottom, #87CEEB 0%, #B0E0E6 50%, #ADD8E6 100%);
            cursor: text;
        }
        .input-field:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.6);
        }
        .control-panel label {
            display: block;
            margin-bottom: 0.5rem;
            color: #4A5568;
        }
        .control-panel input[type="range"] {
            width: 100%;
        }
        /* Keyboard styles */
        .key {
            border: 1px solid #9ca3af;
            border-bottom-width: 3px;
        }
        .key.highlight {
            background-color: #3b82f6 !important; /* Blue 500, use !important to override finger color */
            color: white !important;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.6);
            border-color: #2563eb !important;
        }
        .finger.highlight-finger {
            transform: translateY(-10px) scale(1.2); /* 向上移動並放大 */
            transform-origin: bottom center; /* 從底部中心開始縮放 */
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div id="game-container" class="w-full max-w-5xl mx-auto bg-white rounded-lg shadow-2xl p-4 sm:p-6 relative overflow-hidden">
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-4">Puti-AI 中英打字遊戲</h1>
        <button id="fullscreen-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition z-20" title="切換全螢幕">
            <svg id="enter-fullscreen-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
            <svg id="exit-fullscreen-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></svg>
        </button>
        
        <!-- 遊戲狀態顯示 -->
        <div class="flex justify-between items-center bg-gray-200 p-3 rounded-lg mb-4 text-sm sm:text-base">
            <div><strong>等級:</strong> <span id="level">1</span></div>
            <div><strong>分數:</strong> <span id="score">0</span></div>
            <div><strong>時間:</strong> <span id="timer">3:00</span></div>
            <div><strong>墜毀:</strong> <span id="crashes">0 / 3</span></div>
        </div>

        <!-- 遊戲畫布 -->
        <canvas id="gameCanvas" class="w-full h-96 sm:h-[500px] bg-blue-200 rounded-lg shadow-inner game-canvas"></canvas>
        
        <!-- 輸入區域 -->
        <div class="mt-4">
            <input type="text" id="text-input" placeholder="在這裡輸入文字..."
                   class="w-full p-3 border-2 border-gray-300 rounded-lg text-center text-xl transition duration-200 input-field"
                   autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" disabled>
        </div>
        
        <!-- 鍵盤教學區 -->
        <div id="keyboard-container" class="mt-4 hidden">
            <div id="keyboard" class="p-2 bg-gray-200 rounded-lg shadow-inner">
                <!-- Keys will be generated by JS -->
            </div>
            <div id="hand-guide" class="flex justify-center items-end gap-8 mt-4 h-24">
                <!-- Left Hand -->
                <div class="flex items-end gap-1">
                    <div id="finger-left-pinky" class="finger w-6 h-12 rounded-lg transition-all duration-150 border-2"></div>
                    <div id="finger-left-ring" class="finger w-6 h-14 rounded-lg transition-all duration-150 border-2"></div>
                    <div id="finger-left-middle" class="finger w-6 h-16 rounded-lg transition-all duration-150 border-2"></div>
                    <div id="finger-left-index" class="finger w-6 h-14 rounded-lg transition-all duration-150 border-2"></div>
                    <div id="finger-left-thumb" class="finger w-8 h-10 rounded-lg transition-all duration-150 border-2 ml-2"></div>
                </div>
                <!-- Right Hand -->
                <div class="flex items-end gap-1">
                    <div id="finger-right-thumb" class="finger w-8 h-10 rounded-lg transition-all duration-150 border-2 mr-2"></div>
                    <div id="finger-right-index" class="finger w-6 h-14 rounded-lg transition-all duration-150 border-2"></div>
                    <div id="finger-right-middle" class="finger w-6 h-16 rounded-lg transition-all duration-150 border-2"></div>
                    <div id="finger-right-ring" class="finger w-6 h-14 rounded-lg transition-all duration-150 border-2"></div>
                    <div id="finger-right-pinky" class="finger w-6 h-12 rounded-lg transition-all duration-150 border-2"></div>
                </div>
            </div>
        </div>

        <!-- 遊戲設定 Modal -->
        <div id="start-modal" class="absolute inset-0 flex items-center justify-center modal z-10">
            <div class="bg-white p-8 rounded-lg shadow-xl text-center w-11/12 max-w-md">
                <h2 class="text-2xl font-bold mb-4">準備好了嗎？</h2>
                <p class="text-gray-600 mb-6">選擇遊戲難度並開始挑戰！</p>
                <div class="control-panel text-left mb-6">
                     <div>
                        <label for="level-select">選擇關卡:</label>
                        <select id="level-select" class="w-full p-2 border rounded">
                            <option value="0">等級 0: 注音符號 (直接按鍵)</option>
                            <option value="1">等級 1: 中文單字</option>
                            <option value="2">等級 2: 中文雙字</option>
                            <option value="3">等級 3: 中文三字</option>
                            <option value="4">等級 4: 中文成語</option>
                            <option value="5">等級 5: 英文單字母</option>
                            <option value="6">等級 6: 英文短詞 (3-4 letters)</option>
                            <option value="7">等級 7: 英文中長詞 (5-7 letters)</option>
                            <option value="8">等級 8: 英文長詞 (8+ letters)</option>
                            <option value="9">等級 9: 中英隨機挑戰</option>
                            <option value="10">等級 10: 自訂練習</option>
                        </select>
                    </div>
                    <div class="mt-4">
                        <label for="drone-speed">無人機速度 (慢 &rarr; 快): <span id="drone-speed-value">0.5</span></label>
                        <input type="range" id="drone-speed" min="0.2" max="2" value="0.5" step="0.1">
                    </div>
                    <div class="mt-4">
                        <label for="spawn-rate">無人機頻率 (少 &rarr; 多): <span id="spawn-rate-value">3.0</span>s</label>
                        <input type="range" id="spawn-rate" min="1" max="5" value="3" step="0.2">
                    </div>
                </div>
                <button id="start-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-xl transition duration-300">
                    開始遊戲
                </button>
            </div>
        </div>

        <!-- 遊戲結束 Modal -->
        <div id="game-over-modal" class="absolute inset-0 items-center justify-center modal hidden z-10">
            <div class="bg-white p-8 rounded-lg shadow-xl text-center w-11/12 max-w-md">
                <h2 class="text-3xl font-bold mb-2 text-red-600">遊戲結束！</h2>
                <p class="text-gray-700 mb-4 text-lg">您的最終分數是:</p>
                <p id="final-score" class="text-5xl font-bold mb-6 text-blue-600">0</p>
                <button id="restart-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-xl transition duration-300">
                    重新開始
                </button>
            </div>
        </div>
        
        <!-- 自訂文字 Modal -->
        <div id="custom-words-modal" class="absolute inset-0 items-center justify-center modal hidden z-20">
            <div class="bg-white p-8 rounded-lg shadow-xl text-center w-11/12 max-w-lg">
                <h2 class="text-2xl font-bold mb-4">自訂練習內容</h2>
                <p class="text-gray-600 mb-4">請在下方輸入您想練習的生字語詞，每行一個。</p>
                <textarea id="custom-words-input" class="w-full h-48 p-2 border rounded mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例如：&#10;蘋果&#10;banana&#10;持之以恆"></textarea>
                <div class="flex justify-end gap-4">
                    <button id="cancel-custom-words-button" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                        取消
                    </button>
                    <button id="save-custom-words-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                        儲存並開始
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // UI Elements
    const levelEl = document.getElementById('level');
    const scoreEl = document.getElementById('score');
    const timerEl = document.getElementById('timer');
    const crashesEl = document.getElementById('crashes');
    const textInput = document.getElementById('text-input');
    const startModal = document.getElementById('start-modal');
    const gameOverModal = document.getElementById('game-over-modal');
    const startButton = document.getElementById('start-button');
    const restartButton = document.getElementById('restart-button');
    const finalScoreEl = document.getElementById('final-score');
    const levelSelect = document.getElementById('level-select');
    const droneSpeedSlider = document.getElementById('drone-speed');
    const spawnRateSlider = document.getElementById('spawn-rate');
    const droneSpeedValueEl = document.getElementById('drone-speed-value');
    const spawnRateValueEl = document.getElementById('spawn-rate-value');
    const customWordsModal = document.getElementById('custom-words-modal');
    const customWordsInput = document.getElementById('custom-words-input');
    const saveCustomWordsButton = document.getElementById('save-custom-words-button');
    const cancelCustomWordsButton = document.getElementById('cancel-custom-words-button');
    const keyboardContainer = document.getElementById('keyboard-container');
    const gameContainer = document.getElementById('game-container');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const enterFullscreenIcon = document.getElementById('enter-fullscreen-icon');
    const exitFullscreenIcon = document.getElementById('exit-fullscreen-icon');

    let gameLoopId;
    let timerId;
    let droneSpawnerId;

    // Sound Effects
    let missileSound, explosionSound, gameOverSound, crashExplosionSound;

    const GAME_DURATION = 180; // 3 minutes

    let gameState = {
        score: 0,
        timeLeft: GAME_DURATION,
        crashes: 0,
        maxCrashes: 3,
        level: 0,
        droneSpeed: 0.5,
        spawnRate: 3000, // in ms
        active: false,
    };

    let drones = [];
    let missiles = [];
    let explosions = [];

    // 關卡設定
    const levels = {
        0: ['ㄅ','ㄆ','ㄇ','ㄈ','ㄉ','ㄊ','ㄋ','ㄌ','ㄍ','ㄎ','ㄏ','ㄐ','ㄑ','ㄒ','ㄓ','ㄔ','ㄕ','ㄖ','ㄗ','ㄘ','ㄙ','ㄧ','ㄨ','ㄩ','ㄚ','ㄛ','ㄜ','ㄝ','ㄞ','ㄟ','ㄠ','ㄡ','ㄢ','ㄣ','ㄤ','ㄥ','ㄦ','ˊ','ˇ','ˋ','˙'],
        1: ['天','地','人','你','我','他','山','水','火','木','金','日','月','星','風','雨','雷','電','上','下','左','右','前','後','東','西','南','北','中','發'],
        2: ['你好','謝謝','台灣','台北','電腦','手機','遊戲','學習','程式','未來','快樂','成功','天氣','吃飯','朋友','學校','老師','同學','運動','健康','音樂','電影','旅遊','美食','家人','寵物','希望','夢想','努力','加油'],
        3: ['沒問題','為什麼','怎麼辦','你好嗎','我愛你','真的嗎','太好了','不客氣','對不起','沒關係','辛苦了','逛夜市','看電影','喝珍奶','寫作業','打籃球','聽音樂','去旅行','吃早餐','睡午覺','上網路','玩遊戲','交朋友','學中文','很開心','不知道','等一下','歡迎你','祝你好運','一路順風'],
        4: ['一見鍾情','心想事成','萬事如意','平步青雲','百花齊放','千變萬化','畫龍點睛','車水馬龍','風和日麗','鳥語花香','一心一意','三心二意','五花八門','七上八下','九牛一毛','十全十美','自由自在','無憂無慮','大開眼界','得心應手','飲水思源','守株待兔','亡羊補牢','井底之蛙','狐假虎威','畫蛇添足','驚弓之鳥','對牛彈琴','掩耳盜鈴','自相矛盾'],
        5: ['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z'],
        6: ['run', 'sun', 'cat', 'dog', 'pen', 'box', 'key', 'cup', 'hat', 'map', 'bus', 'car', 'fly', 'sky', 'try', 'egg', 'jam', 'ice', 'fan', 'bed', 'leg', 'arm', 'lip', 'eye', 'ear', 'ant', 'bee', 'cow', 'fox', 'pig'],
        7: ['apple', 'banana', 'orange', 'grape', 'lemon', 'melon', 'peach', 'water', 'earth', 'happy', 'smile', 'dream', 'music', 'style', 'power', 'magic', 'light', 'sound', 'color', 'shape', 'space', 'cloud', 'green', 'white', 'black', 'brown', 'friend', 'family', 'school', 'world'],
        8: ['computer', 'keyboard', 'internet', 'program', 'language', 'challenge', 'success', 'beautiful', 'wonderful', 'important', 'technology', 'information', 'adventure', 'experience', 'knowledge', 'education', 'development', 'environment', 'celebration', 'imagination'],
        9: [], // 中英隨機挑戰
        10: []  // 自訂關卡
    };
    levels[9] = [...levels[1], ...levels[2], ...levels[3], ...levels[4], ...levels[6], ...levels[7], ...levels[8]];

    const levelDisplayNames = { 0: '注音', 9: '隨機', 10: '自訂' };
    
    // --- 鍵盤教學相關 ---
    const keyboardLayout = [
        { symbol: 'ㄅ', key: '1', finger: 'left-pinky' }, { symbol: 'ㄉ', key: '2', finger: 'left-ring' }, { symbol: 'ˇ', key: '3', finger: 'left-middle' }, { symbol: 'ˋ', key: '4', finger: 'left-index' }, { symbol: 'ㄓ', key: '5', finger: 'left-index' }, { symbol: 'ˊ', key: '6', finger: 'right-index' }, { symbol: '˙', key: '7', finger: 'right-index' }, { symbol: 'ㄚ', key: '8', finger: 'right-middle' }, { symbol: 'ㄞ', key: '9', finger: 'right-ring' }, { symbol: 'ㄢ', key: '0', finger: 'right-pinky' }, { symbol: 'ㄦ', key: '-', finger: 'right-pinky' },
        { symbol: 'ㄆ', key: 'q', finger: 'left-pinky' }, { symbol: 'ㄊ', key: 'w', finger: 'left-ring' }, { symbol: 'ㄍ', key: 'e', finger: 'left-middle' }, { symbol: 'ㄐ', key: 'r', finger: 'left-index' }, { symbol: 'ㄔ', key: 't', finger: 'left-index' }, { symbol: 'ㄗ', key: 'y', finger: 'right-index' }, { symbol: 'ㄧ', key: 'u', finger: 'right-index' }, { symbol: 'ㄛ', key: 'i', finger: 'right-middle' }, { symbol: 'ㄟ', key: 'o', finger: 'right-ring' }, { symbol: 'ㄣ', key: 'p', finger: 'right-pinky' },
        { symbol: 'ㄇ', key: 'a', finger: 'left-pinky' }, { symbol: 'ㄋ', key: 's', finger: 'left-ring' }, { symbol: 'ㄎ', key: 'd', finger: 'left-middle' }, { symbol: 'ㄑ', key: 'f', finger: 'left-index' }, { symbol: 'ㄕ', key: 'g', finger: 'left-index' }, { symbol: 'ㄘ', key: 'h', finger: 'right-index' }, { symbol: 'ㄨ', key: 'j', finger: 'right-index' }, { symbol: 'ㄜ', key: 'k', finger: 'right-middle' }, { symbol: 'ㄠ', key: 'l', finger: 'right-ring' }, { symbol: 'ㄤ', key: ';', finger: 'right-pinky' },
        { symbol: 'ㄈ', key: 'z', finger: 'left-pinky' }, { symbol: 'ㄌ', key: 'x', finger: 'left-ring' }, { symbol: 'ㄏ', key: 'c', finger: 'left-middle' }, { symbol: 'ㄒ', key: 'v', finger: 'left-index' }, { symbol: 'ㄖ', key: 'b', finger: 'left-index' }, { symbol: 'ㄙ', key: 'n', finger: 'right-index' }, { symbol: 'ㄩ', key: 'm', finger: 'right-index' }, { symbol: 'ㄝ', key: ',', finger: 'right-middle' }, { symbol: 'ㄡ', key: '.', finger: 'right-ring' }, { symbol: 'ㄥ', key: '/', finger: 'right-pinky' },
    ];
    const fingerNames = { 'left-pinky': '左小指', 'left-ring': '左無名指', 'left-middle': '左中指', 'left-index': '左食指', 'right-index': '右食指', 'right-middle': '右中指', 'right-ring': '右無名指', 'right-pinky': '右小指' };
    const fingerColors = {
        'left-pinky':  { bg: '#fca5a5', border: '#ef4444' }, // red 300/500
        'left-ring':   { bg: '#fdba74', border: '#f97316' }, // orange 300/500
        'left-middle': { bg: '#fde047', border: '#eab308' }, // yellow 300/500
        'left-index':  { bg: '#bef264', border: '#84cc16' }, // lime 300/500
        'left-thumb':  { bg: '#e5e7eb', border: '#9ca3af' }, // gray 200/400
        'right-thumb': { bg: '#e5e7eb', border: '#9ca3af' }, // gray 200/400
        'right-index': { bg: '#86efac', border: '#22c55e' }, // green 300/500
        'right-middle':{ bg: '#67e8f9', border: '#06b6d4' }, // cyan 300/500
        'right-ring':  { bg: '#c4b5fd', border: '#8b5cf6' }, // violet 300/500
        'right-pinky': { bg: '#f9a8d4', border: '#ec4899' }, // pink 300/500
    };

    const keyboardRows = [ ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0', '-'], ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p'], ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l', ';'], ['z', 'x', 'c', 'v', 'b', 'n', 'm', ',', '.', '/'] ];
    const keyMap = new Map(keyboardLayout.map(k => [k.symbol, k]));
    const symbolMap = new Map(keyboardLayout.map(k => [k.key, k]));

    function createKeyboard() {
        const keyboardEl = document.getElementById('keyboard');
        keyboardEl.innerHTML = '';
        const keySymbolMap = new Map(keyboardLayout.map(k => [k.key, k]));
        keyboardRows.forEach((row, rowIndex) => {
            const rowEl = document.createElement('div');
            rowEl.className = 'flex justify-center gap-1 my-1 w-full';
            if (rowIndex === 1) rowEl.style.paddingLeft = '2.5%'; 
            if (rowIndex === 2) rowEl.style.paddingLeft = '5%';
            if (rowIndex === 3) rowEl.style.paddingLeft = '8.5%';

            row.forEach(keyChar => {
                const keyData = keySymbolMap.get(keyChar);
                const keyEl = document.createElement('div');
                keyEl.className = 'key flex-grow basis-0 flex items-center justify-center h-12 rounded-md shadow text-lg font-sans transition-all duration-150';
                
                if (keyData) {
                    keyEl.textContent = keyData.symbol;
                    keyEl.dataset.symbol = keyData.symbol;
                    keyEl.dataset.finger = keyData.finger;
                    keyEl.title = fingerNames[keyData.finger];
                    
                    const finger = keyData.finger;
                    const colors = fingerColors[finger];
                    if (colors) {
                        keyEl.style.backgroundColor = colors.bg;
                        keyEl.style.borderColor = colors.border;
                    }
                    keyEl.style.color = '#1f2937';
                } else {
                    keyEl.textContent = keyChar.toUpperCase();
                    keyEl.style.backgroundColor = '#F1F5F9';
                }
                rowEl.appendChild(keyEl);
            });
            keyboardEl.appendChild(rowEl);
        });
    }
    
    function colorFingerIcons() {
        document.querySelectorAll('.finger').forEach(fingerEl => {
            const fingerId = fingerEl.id.replace('finger-', '');
            const colors = fingerColors[fingerId];
            if (colors) {
                fingerEl.style.backgroundColor = colors.bg;
                fingerEl.style.borderColor = colors.border;
            }
        });
    }

    function highlightFinger(fingerId) {
        document.querySelectorAll('.finger.highlight-finger').forEach(f => f.classList.remove('highlight-finger'));
        if (fingerId) {
            const fingerEl = document.getElementById(`finger-${fingerId}`);
            if (fingerEl) {
                fingerEl.classList.add('highlight-finger');
            }
        }
    }

    function highlightKey(symbol) {
        document.querySelectorAll('.key.highlight').forEach(k => k.classList.remove('highlight'));
        
        if (!symbol) {
            highlightFinger(null);
            return;
        }
        const keyData = keyMap.get(symbol);
        if (keyData) {
            const keyEl = document.querySelector(`.key[data-symbol="${symbol}"]`);
            if (keyEl) {
                keyEl.classList.add('highlight');
                highlightFinger(keyData.finger);
            }
        }
    }

    // --- 全螢幕控制 ---
    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            gameContainer.requestFullscreen().catch(err => {
                console.error(`全螢幕模式失敗: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    }

    function updateFullscreenIcon() {
        if (document.fullscreenElement) {
            enterFullscreenIcon.classList.add('hidden');
            exitFullscreenIcon.classList.remove('hidden');
        } else {
            enterFullscreenIcon.classList.remove('hidden');
            exitFullscreenIcon.classList.add('hidden');
        }
    }

    function resizeCanvas() {
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    
    // --- 繪圖函式 ---
    function drawDrones() {
        drones.forEach(drone => {
            const bodyRadius = 15;
            const armLength = 25;
            const propellerRadius = 5;
            ctx.save();
            ctx.translate(drone.x, drone.y);
            ctx.strokeStyle = '#718096';
            ctx.lineWidth = 4;
            for (let i = 0; i < 4; i++) {
                ctx.beginPath();
                ctx.moveTo(0, 0);
                const angle = (Math.PI / 4) + (i * Math.PI / 2);
                ctx.lineTo(Math.cos(angle) * armLength, Math.sin(angle) * armLength);
                ctx.stroke();
            }
            ctx.lineWidth = 2;
            for (let i = 0; i < 4; i++) {
                const angle = (Math.PI / 4) + (i * Math.PI / 2);
                const armX = Math.cos(angle) * armLength;
                const armY = Math.sin(angle) * armLength;
                ctx.save();
                ctx.translate(armX, armY);
                ctx.rotate(drone.propellerAngle);
                ctx.strokeStyle = drone.isTargeted ? '#F56565' : '#A0AEC0';
                ctx.beginPath();
                ctx.moveTo(-propellerRadius - 2, 0);
                ctx.lineTo(propellerRadius + 2, 0);
                ctx.stroke();
                ctx.restore();
            }
            ctx.fillStyle = '#4A5568';
            ctx.beginPath();
            ctx.arc(0, 0, bodyRadius, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#2D3748';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = 'white';
            ctx.font = 'bold 18px "Noto Sans TC"';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(drone.text, 0, 0);
            ctx.restore();
        });
    }

    function drawMissiles() {
        missiles.forEach(missile => {
            ctx.fillStyle = '#F56565';
            ctx.beginPath();
            ctx.arc(missile.x, missile.y, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = 'orange';
            ctx.beginPath();
            ctx.arc(missile.x, missile.y + 8, 3, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    function drawExplosions() {
        explosions.forEach(explosion => {
            ctx.fillStyle = `rgba(255, 165, 0, ${explosion.alpha})`;
            ctx.beginPath();
            ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = `rgba(255, 69, 0, ${explosion.alpha})`;
            ctx.beginPath();
            ctx.arc(explosion.x, explosion.y, explosion.radius / 2, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    function drawLauncher() {
        const launcherWidth = 60;
        const launcherHeight = 30;
        const x = canvas.width / 2;
        const y = canvas.height;
        ctx.fillStyle = '#2D3748';
        ctx.beginPath();
        ctx.moveTo(x - launcherWidth / 2, y);
        ctx.lineTo(x + launcherWidth / 2, y);
        ctx.lineTo(x + launcherWidth / 2 - 10, y - launcherHeight);
        ctx.lineTo(x - launcherWidth / 2 + 10, y - launcherHeight);
        ctx.closePath();
        ctx.fill();
        ctx.fillStyle = '#4A5568';
        ctx.fillRect(x - 5, y - launcherHeight - 15, 10, 15);
    }
    
    // --- 更新遊戲狀態 ---
    function updateDrones() {
        drones.forEach((drone, index) => {
            drone.y += gameState.droneSpeed;
            drone.propellerAngle += 0.5;
            if (drone.y > canvas.height) {
                if (gameState.level === 0) highlightKey(null);
                drones.splice(index, 1);
                gameState.crashes++;
                updateUI();
                createExplosion(drone.x, canvas.height);
                if(crashExplosionSound) { crashExplosionSound.triggerAttackRelease("0.8", Tone.now()); }
                if (gameState.crashes >= gameState.maxCrashes) { endGame(); }
            }
        });
    }

    function updateMissiles() {
        missiles.forEach((missile, index) => {
            const target = missile.target;
            const dx = target.x - missile.x;
            const dy = target.y - missile.y;
            const dist = Math.sqrt(dx * dx + dy * dy);

            if (dist < 10 || !drones.includes(target)) {
                if (gameState.level === 0) highlightKey(null);
                createExplosion(target.x, target.y);
                if (drones.includes(target)) {
                    explosionSound.triggerAttackRelease("0.3", Tone.now());
                    gameState.score += target.text.length * 10;
                    updateUI();
                    drones = drones.filter(d => d !== target);
                }
                missiles.splice(index, 1);
            } else {
                missile.x += (dx / dist) * 8;
                missile.y += (dy / dist) * 8;
            }
        });
    }
    
    function updateExplosions() {
        explosions.forEach((explosion, index) => {
            explosion.radius += 1;
            explosion.alpha -= 0.02;
            if (explosion.alpha <= 0) { explosions.splice(index, 1); }
        });
    }

    function spawnDrone() {
        if (gameState.level === 0 && drones.length > 0) return;
        const wordList = levels[gameState.level];
        if (!wordList || wordList.length === 0) return;
        const text = wordList[Math.floor(Math.random() * wordList.length)];
        const textWidth = 40;
        const newDrone = {
            text: text,
            x: Math.random() * (canvas.width - textWidth - 20) + textWidth / 2 + 10,
            y: -30, isTargeted: false, propellerAngle: 0,
        };
        drones.push(newDrone);
        if (gameState.level === 0) highlightKey(newDrone.text);
    }
    
    function createExplosion(x, y) { explosions.push({ x: x, y: y, radius: 10, alpha: 1 }); }

    // --- 遊戲主循環 ---
    function gameLoop() {
        if (!gameState.active) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        updateDrones(); updateMissiles(); updateExplosions();
        drawLauncher(); drawDrones(); drawMissiles(); drawExplosions();
        gameLoopId = requestAnimationFrame(gameLoop);
    }

    // --- 遊戲流程控制 ---
    function setupSounds() {
        missileSound = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();
        explosionSound = new Tone.NoiseSynth({ noise: { type: "white" }, envelope: { attack: 0.005, decay: 0.3, sustain: 0 } }).toDestination();
        crashExplosionSound = new Tone.NoiseSynth({ noise: { type: "brown" }, envelope: { attack: 0.05, decay: 0.8, sustain: 0.1 } }).toDestination();
        crashExplosionSound.volume.value = 3;
        gameOverSound = new Tone.Synth().toDestination();
    }

    function init() {
        resizeCanvas();
        createKeyboard();
        colorFingerIcons();
        updateSettingsUI();
        
        startButton.addEventListener('click', async () => {
            await Tone.start(); setupSounds();
            if (levelSelect.value === '10') {
                startModal.classList.add('hidden'); startModal.classList.remove('flex');
                customWordsModal.classList.remove('hidden'); customWordsModal.classList.add('flex');
                customWordsInput.focus();
            } else { startGame(); }
        });

        restartButton.addEventListener('click', () => {
            gameOverModal.classList.add('hidden'); gameOverModal.classList.remove('flex');
            startModal.classList.remove('hidden'); startModal.classList.add('flex');
        });

        document.addEventListener('keydown', handleKeyDown);
        
        saveCustomWordsButton.addEventListener('click', () => {
            const words = customWordsInput.value.trim().split('\n').map(w => w.trim()).filter(w => w.length > 0);
            if (words.length === 0) { customWordsInput.value = ''; customWordsInput.placeholder = "請至少輸入一個詞！"; return; }
            levels[10] = words;
            customWordsModal.classList.add('hidden'); customWordsModal.classList.remove('flex');
            startGame();
        });

        cancelCustomWordsButton.addEventListener('click', () => {
            customWordsModal.classList.add('hidden'); customWordsModal.classList.remove('flex');
            startModal.classList.remove('hidden'); startModal.classList.add('flex');
        });

        droneSpeedSlider.addEventListener('input', (e) => { droneSpeedValueEl.textContent = parseFloat(e.target.value).toFixed(1); });
        spawnRateSlider.addEventListener('input', (e) => { spawnRateValueEl.textContent = (6 - parseFloat(e.target.value)).toFixed(1); });
        fullscreenBtn.addEventListener('click', toggleFullScreen);
        document.addEventListener('fullscreenchange', updateFullscreenIcon);
    }

    function startGame() {
        gameState.score = 0; gameState.timeLeft = GAME_DURATION; gameState.crashes = 0;
        gameState.level = parseInt(levelSelect.value, 10);
        gameState.droneSpeed = parseFloat(droneSpeedSlider.value);
        gameState.spawnRate = (6 - parseFloat(spawnRateSlider.value)) * 1000;
        drones = []; missiles = []; explosions = []; gameState.active = true;
        updateUI();
        startModal.classList.add('hidden'); startModal.classList.remove('flex');
        textInput.disabled = false; textInput.focus();
        if (gameState.level === 0) {
            keyboardContainer.classList.remove('hidden');
            textInput.placeholder = "請直接按對應的鍵盤按鍵！";
            textInput.readOnly = true;
        } else {
            keyboardContainer.classList.add('hidden');
            textInput.placeholder = "在這裡輸入文字...";
            textInput.readOnly = false;
        }
        highlightKey(null);
        timerId = setInterval(updateTimer, 1000);
        droneSpawnerId = setInterval(spawnDrone, gameState.spawnRate);
        gameLoop();
    }

    function endGame() {
        gameState.active = false;
        clearInterval(timerId); clearInterval(droneSpawnerId); cancelAnimationFrame(gameLoopId);
        const now = Tone.now();
        gameOverSound.triggerAttackRelease("C4", "8n", now);
        gameOverSound.triggerAttackRelease("G3", "8n", now + 0.2);
        gameOverSound.triggerAttackRelease("E3", "4n", now + 0.4);
        textInput.disabled = true; textInput.value = ''; textInput.readOnly = false;
        textInput.placeholder = "在這裡輸入文字...";
        finalScoreEl.textContent = gameState.score;
        gameOverModal.classList.remove('hidden'); gameOverModal.classList.add('flex');
        keyboardContainer.classList.add('hidden');
        highlightKey(null);
    }

    function updateUI() {
        levelEl.textContent = levelDisplayNames[gameState.level] || gameState.level;
        scoreEl.textContent = gameState.score;
        crashesEl.textContent = `${gameState.crashes} / ${gameState.maxCrashes}`;
        const minutes = Math.floor(gameState.timeLeft / 60);
        const seconds = gameState.timeLeft % 60;
        timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function updateSettingsUI() {
        droneSpeedValueEl.textContent = parseFloat(droneSpeedSlider.value).toFixed(1);
        spawnRateValueEl.textContent = (6 - parseFloat(spawnRateSlider.value)).toFixed(1);
    }
    
    function updateTimer() {
        gameState.timeLeft--; updateUI();
        if (gameState.timeLeft <= 0) { endGame(); }
    }

    function handleKeyDown(e) {
        if (!gameState.active || (document.activeElement === customWordsInput)) return;

        if (gameState.level === 0) {
            e.preventDefault();
            const keyData = symbolMap.get(e.key);
            if (!keyData) return;
            const symbolToFind = keyData.symbol;
            const targetDrone = drones.find(d => d.text === symbolToFind && !d.isTargeted);

            if (targetDrone) {
                targetDrone.isTargeted = true;
                missiles.push({ x: canvas.width / 2, y: canvas.height - 40, target: targetDrone });
                const now = Tone.now();
                missileSound.triggerAttack("C5", now); missileSound.frequency.rampTo("G5", 0.2, now); missileSound.triggerRelease(now + 0.2);
            }
        } else {
            if (e.key === 'Enter' && textInput.value.trim() !== '') {
                const inputText = textInput.value.trim();
                const targetDrone = drones.slice().reverse().find(d => d.text.toLowerCase() === inputText.toLowerCase() && !d.isTargeted);
                if (targetDrone) {
                    targetDrone.isTargeted = true;
                    missiles.push({ x: canvas.width / 2, y: canvas.height - 40, target: targetDrone });
                    const now = Tone.now();
                    missileSound.triggerAttack("C5", now); missileSound.frequency.rampTo("G5", 0.2, now); missileSound.triggerRelease(now + 0.2);
                }
                textInput.value = '';
            }
        }
    }
    
    init();
</script>
</body>
</html>

